name: "[./.github/workflows/travis-publish-third-party.yaml]"

on:
  workflow_call:
    inputs:
      tag:
        description: "The tag of the release to publish"
        type: string
        required: true
        default: 2025.03.0
      IS_STABLE_RELEASE:
        required: true
        default: false
        type: string
    secrets:
      BOT_TOKEN:
        required: true
        description: "The token used to authenticate to the Github API"

run-name: Auto publishing ${{ inputs.tag }} to external stores

jobs:
  get-tag-info:
    runs-on: ubuntu-latest
    name: Get tag info 🏷️

    outputs:
      commit_hash: ${{ steps.tag_data.outputs.commit_hash }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true
          ref: ${{ inputs.tag }}

      - name: Get tag data
        id: tag_data
        run: |
          echo "commit_hash=$(git rev-parse --short=7 HEAD)" >> "$GITHUB_OUTPUT"

  #
  # ██████╗ ███████╗██╗     ███████╗ █████╗ ███████╗███████╗
  # ██╔══██╗██╔════╝██║     ██╔════╝██╔══██╗██╔════╝██╔════╝
  # ██████╔╝█████╗  ██║     █████╗  ███████║███████╗█████╗
  # ██╔══██╗██╔══╝  ██║     ██╔══╝  ██╔══██║╚════██║██╔══╝
  # ██║  ██║███████╗███████╗███████╗██║  ██║███████║███████╗
  # ╚═╝  ╚═╝╚══════╝╚══════╝╚══════╝╚═╝  ╚═╝╚══════╝╚══════╝
  #

  windows:
    needs: get-tag-info
    runs-on: ubuntu-latest
    name: Publish to windows 🪟

    steps:
      - name: Get Previous Release info
        # This version incementation shall be removed when winget-releaser will be able to delete older releases again cf. https://github.com/gama-platform/gama/issues/3917
        if: "${{ !inputs.IS_STABLE_RELEASE }}"
        id: get-prev-release
        run: |
          curl -L -G \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/microsoft/winget-pkgs/contents/manifests/g/GamaPlatform/GamaAlpha" > ${{ runner.temp }}/prev_release.json

            new_version_counter="$(jq -r '.[] | select(.type == "dir") | select(.name | test("^${{ inputs.tag }}-[0-9]+$")) | .name' ${{ runner.temp }}/prev_release.json | cut -d '-' -f 2 | sort -nuz | head -n1)"
            if [ -n "$new_version_counter" ]; then
              new_version_counter=$(($new_version_counter + 1))
            else
              new_version_counter=1
            fi
            echo "new_version_counter=$new_version_counter" >> $GITHUB_OUTPUT

      - name: Publish Stable release to Winget 🚀
        if: "${{ inputs.IS_STABLE_RELEASE }}"
        uses: vedantmgoyal2009/winget-releaser@v2
        with:
          identifier: GamaPlatform.Gama
          version: ${{ inputs.tag }}
          release-tag: ${{ inputs.tag }}
          installers-regex: ^GAMA.+JDK.*\.exe$
          token: ${{ secrets.BOT_TOKEN }}
          fork-user: gama-platform

      - name: Publish Pre release to Winget 👷
        if: "${{ !inputs.IS_STABLE_RELEASE }}"
        uses: vedantmgoyal2009/winget-releaser@v2
        with:
          identifier: GamaPlatform.GamaAlpha
          version: ${{ inputs.tag }}-${{ steps.get-prev-release.outputs.new_version_counter }}
          release-tag: ${{ inputs.tag }}
          installers-regex: ^GAMA.+JDK.*\.exe$
          token: ${{ secrets.BOT_TOKEN }}
          max-versions-to-keep: 1
          fork-user: gama-platform

      - name: Get PR created for the release
        id: get-pr
        run: |
          # Add delay to let the PR being opened and API to update
          sleep 10
          #  
          curl -G \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.BOT_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            --data-urlencode "q=is:pr author:gama-bot state:open repo:microsoft/winget-pkgs sort:created-desc" \
            "https://api.github.com/search/issues?sort=created&order=desc&per_page=1" | tee ${{ runner.temp }}/pr.json
          #
          echo "number=$(jq -r '.items[0].number' ${{ runner.temp }}/pr.json)" >> $GITHUB_OUTPUT

      - name: Mention developpers
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.BOT_TOKEN}}
          script: |
            let is_pre_release = "${{ !inputs.IS_STABLE_RELEASE }}"

            github.issues.createComment({
              issue_number: ${{ steps.get-pr.outputs.number }},
              owner: "microsoft",
              repo: "winget-pkgs",
              body: 'Poke :point_right: @${{ github.triggering_actor }} @lesquoyb @RoiArthurB'
            })

            core.summary.
              addHeading(
                `Release ${{ inputs.tag }}${(is_pre_release)? "" : "-${{ steps.get-prev-release.outputs.new_version_counter }} alpha (with hash ${{needs.get-tag-info.outputs.commit_hash }})" } published to Winget 🚀`
              )
              .addLink("Link to the Winget PR", "https://github.com/microsoft/winget-pkgs/pull/${{ steps.get-pr.outputs.number }}")
              .write()

  docker:
    needs: get-tag-info
    runs-on: ubuntu-latest
    if: "${{ !inputs.IS_STABLE_RELEASE }}"
    name: Publish pre-release as container 🐳

    steps:
      - name: Generate new alpha container 👷
        run: |
          curl --request POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.BOT_TOKEN }}" \
            --data '{"event_type": "automated-generation"}' \
            https://api.github.com/repos/gama-platform/gama.docker/dispatches

  linux-debian:
    needs: get-tag-info
    runs-on: ubuntu-latest
    name: Publish to PPA/Debian repo 🐧 🟠🔴

    steps:
      - name: Publish Gama to https://ppa.gama-platform.org 🚀
        run: |
          curl -L --fail-with-body \
            --request POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.BOT_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            --data '{"ref": "main", "inputs": {"tag": "${{ inputs.tag }}"}}' \
            https://api.github.com/repos/gama-platform/gama.ppa/actions/workflows/69865833/dispatches

  # linux-arch:
  #   needs: get-tag-info
  #   runs-on: ubuntu-latest
  #   name: Publish to AUR 🐧 🔷

  macos:
    needs: get-tag-info
    if: "${{ inputs.IS_STABLE_RELEASE }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sufix: ["", "_withJDK"]
    name: Publish to Homebrew macos 🍎

    steps:
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      #
      # Get dmgs and sha256
      #
      # Get Mac dmg signed archives
      - uses: actions/download-artifact@v4
        with:
          #name: gama-mac-signed
          path: ${{ github.workspace }}
          pattern: gama-mac-signed-*
          merge-multiple: true

      - name: Install locally official's tap cask
        run: brew tap -f homebrew/homebrew-cask

      - name: Get cask name
        id: getCask
        run: |
          if [ ${{ matrix.sufix }} ]; then
            echo "name=gama-jdk" >> $GITHUB_OUTPUT
          else
            echo "name=gama-platform" >> $GITHUB_OUTPUT
          fi

      - name: Bump GAMA w/ JDK
        env: 
          working_directory: /home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/homebrew/homebrew-cask
        run: |
          # Update cask file with both SHA256 values
          MAC_INTEL=$(shasum -a 256 gama-*.aarch64${{ matrix.sufix }}.dmg |  cut -d ' ' -f 1)
          MAC_ARM=$(shasum -a 256 gama-*.x86_64${{ matrix.sufix }}.dmg |  cut -d ' ' -f 1)

          sed -i -e "/arm:/s/\"[0-9a-f]\{64\}\"/\"$MAC_ARM\"/" -e "/intel:/s/\"[0-9a-f]\{64\}\"/\"$MAC_INTEL\"/" Casks/g/${{ steps.getCask.outputs.name }}.rb
          sed -i "s/version \"[0-9.]*\"/version \"${{ inputs.tag }}\"/" Casks/g/${{ steps.getCask.outputs.name }}.rb

      - name: Brew verification
        run: |
          brew audit --cask ${{ steps.getCask.outputs.name }}
          brew style --fix ${{ steps.getCask.outputs.name }}

      - name: Create Homebrew PR 
        env: 
          working_directory: /home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/homebrew/homebrew-cask
        run: |
          # Configure git
          git config user.name ${{ secrets.BOT_GH_NAME }}
          git config user.email ${{ secrets.BOT_GH_EMAIL }}

          # Create branch
          git checkout -b "${{ steps.getCask.outputs.name }}-${{ inputs.tag }}"

          # Commit and create PR
          git add Casks/g/${{ steps.getCask.outputs.name }}.rb
          git commit -m "${{ steps.getCask.outputs.name }}: update to ${{ inputs.tag }}"

          # Fork and push
          gh repo fork --clone=false
          git push -u origin "${{ steps.getCask.outputs.name }}-${{ inputs.tag }}"

          # Create PR
          gh pr create \
          --repo Homebrew/homebrew-cask \
          --title "${{ steps.getCask.outputs.name }}: update to ${{ inputs.tag }}" \
          --body "**Important:** *Do not tick a checkbox if you haven't performed its action.* Honesty is indispensable for a smooth review process.
_In the following questions \`<cask>\` is the token of the cask you're submitting._

After making any changes to a cask, existing or new, verify:

- [x] The submission is for [a stable version](https://docs.brew.sh/Acceptable-Casks#stable-versions) or [documented exception](https://docs.brew.sh/Acceptable-Casks#but-there-is-no-stable-version).
- [x] \`brew audit --cask --online <cask>\` is error-free.
- [x] \`brew style --fix <cask>\` reports no offenses.

Additionally, **if adding a new cask**:

- [ ] Named the cask according to the [token reference](https://docs.brew.sh/Cask-Cookbook#token-reference).
- [ ] Checked the cask was not [already refused](https://github.com/search?q=repo%3AHomebrew%2Fhomebrew-cask+is%3Aclosed+is%3Aunmerged+&type=pullrequests) (add your cask's name to the end of the search field).
- [ ] \`brew audit --cask --new <cask>\` worked successfully.
- [ ] \`HOMEBREW_NO_INSTALL_FROM_API=1 brew install --cask <cask>\` worked successfully.
- [ ] \`brew uninstall --cask <cask>\` worked successfully.

---

Generated automatically from Github actions
- Release author: @${{ github.triggering_actor }} 
- Poke :point_right: @RoiArthurB @lesquoyb"
